name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true
        type: string

env:
  PHP_VERSION: '8.4'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==============================================
  # Pre-deployment Checks
  # ==============================================
  pre-deployment:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, bcmath, gd, pdo_mysql, zip
          tools: composer:v2

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

      - name: Run PHPStan
        run: ./vendor/bin/phpstan analyse --memory-limit=2G

      - name: Security audit
        run: composer audit

  # ==============================================
  # Build Production Docker Image
  # ==============================================
  build:
    name: Build Production Image
    runs-on: ubuntu-latest
    needs: pre-deployment
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=$(git describe --tags --abbrev=0 2>/dev/null || echo 'latest')" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.prod
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==============================================
  # Blue-Green Deployment
  # ==============================================
  deploy:
    name: Deploy to Production (Blue-Green)
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: https://yourdomain.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy with Blue-Green strategy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/my_profile_laravel

            # Determine current and new environment
            CURRENT=$(cat .current_env 2>/dev/null || echo "blue")
            if [ "$CURRENT" == "blue" ]; then
              NEW="green"
            else
              NEW="blue"
            fi

            echo "Current: $CURRENT, Deploying to: $NEW"

            # Pull latest code and image
            git pull origin main
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

            # Start new environment
            docker-compose -f docker-compose.$NEW.yml up -d

            # Wait for health check
            echo "Waiting for $NEW environment to be healthy..."
            sleep 15

            # Run migrations on new environment
            docker exec my_profile_laravel_app_$NEW php artisan migrate --force

            # Clear caches
            docker exec my_profile_laravel_app_$NEW php artisan cache:clear
            docker exec my_profile_laravel_app_$NEW php artisan config:cache
            docker exec my_profile_laravel_app_$NEW php artisan route:cache
            docker exec my_profile_laravel_app_$NEW php artisan view:cache

            # Health check
            MAX_RETRIES=5
            RETRY=0
            while [ $RETRY -lt $MAX_RETRIES ]; do
              if curl -f http://localhost:808$([[ "$NEW" == "green" ]] && echo "2" || echo "1")/health; then
                echo "$NEW environment is healthy"
                break
              fi
              RETRY=$((RETRY+1))
              echo "Health check failed, retry $RETRY/$MAX_RETRIES"
              sleep 5
            done

            if [ $RETRY -eq $MAX_RETRIES ]; then
              echo "Health check failed after $MAX_RETRIES attempts. Rolling back."
              docker-compose -f docker-compose.$NEW.yml down
              exit 1
            fi

            # Switch traffic to new environment
            echo "Switching traffic to $NEW environment..."
            ./scripts/switch-traffic.sh $NEW

            # Save current environment
            echo $NEW > .current_env

            # Wait before shutting down old environment
            sleep 30

            # Shutdown old environment
            echo "Shutting down $CURRENT environment..."
            docker-compose -f docker-compose.$CURRENT.yml down

            echo "Deployment complete: $NEW is now live"

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/my_profile_laravel
            CURRENT=$(cat .current_env 2>/dev/null || echo "blue")
            echo "Rolling back to $CURRENT"
            ./scripts/switch-traffic.sh $CURRENT

      - name: Create GitHub Release
        if: success() && github.event_name != 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          generate_release_notes: true

      - name: Notify deployment success
        if: success()
        run: echo "✅ Production deployment successful"

      - name: Notify deployment failure
        if: failure()
        run: echo "❌ Production deployment failed and rolled back"
