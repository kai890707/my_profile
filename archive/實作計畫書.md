# 業務推廣系統後端 API 實作計畫

**專案代號**：業務推廣系統轉型
**文件版本**：v1.0
**制定日期**：2026-01-07
**負責角色**：Tech Lead (技術主管)
**預估工時**：8-10 個工作天

---

## 執行摘要

將現有的個人作品集系統（CodeIgniter 4）改造為業務推廣平台後端 API。核心改造包括：建立三角色認證系統（業務員、一般使用者、Admin）、實作 JWT 認證、設計審核機制、開發 RESTful API 端點、實作多條件搜尋功能。採用漸進式改造策略，保留可重用的資料表結構（experiences, education），新建核心業務表（users, salesperson_profiles, companies 等），確保系統安全性與可擴展性。

---

## 需求回顧（來自 PM）

### 功能描述
- **三種角色**：業務員（開放註冊+審核）、一般使用者（免註冊搜尋）、Admin（全權管理）
- **業務員功能**：上傳個人資料、工作經歷、公司資訊、證照，查看審核狀態
- **搜尋功能**：公司名稱、專業領域、產業類別、地區、關鍵字（全文搜尋）
- **審核機制**：首次上傳全審核，後續僅機敏資料（公司資訊、證照）需審核
- **認證機制**：JWT Token（Access Token + Refresh Token）
- **檔案處理**：儲存於資料庫（BLOB 或 Base64）

### 驗收標準（精選核心標準）
- [ ] 業務員可成功註冊，狀態為「待審核」
- [ ] JWT Token 認證正常運作（登入、刷新、權限驗證）
- [ ] 機敏資料修改後需審核，一般資料即時生效
- [ ] 一般使用者可透過多條件搜尋業務員
- [ ] Admin 可審核註冊申請、管理使用者、系統設定
- [ ] 無 SQL Injection、XSS 漏洞，API 端點正確實施權限控制

---

## 技術分析（來自 Architect）

### 現有架構
- **框架**：CodeIgniter 4.6.4 + PHP 8.2 + MySQL 8.0
- **部署**：Docker Compose（app, db, phpmyadmin）
- **資料表**：5 張表（profiles, skills, experiences, education, projects）
- **完成度**：約 35-40%（資料層完整，但無認證系統、無 API、無權限控制）

### 關鍵缺口
1. **無認證系統**：缺少 users 表、Auth Controllers、JWT 機制
2. **無 API 端點**：BaseController 未使用 ResponseTrait，無 API 路由
3. **資料結構不符**：現有 profiles 表為單一使用者設計，不符合多業務員架構
4. **無權限控制**：無 AuthFilter、RoleFilter

### 可重用模組
- **ExperienceModel**：可改造為業務員工作經歷（加上 user_id）
- **EducationModel**：可改造為證照表（加上 user_id、審核狀態）
- **Docker 環境**：完整可用
- **Seeder 機制**：可用於測試資料生成

---

## 技術方案

### 方案選擇

**選擇方案：漸進式資料庫改造 + JWT 認證 + RESTful API**

**理由：**
- **優點**：
  - 保留可重用的表結構（experiences, education），減少開發成本
  - JWT 無狀態設計，適合前後端分離，易於水平擴展
  - RESTful 設計標準化，前端易於整合
  - 審核機制採用狀態欄位設計，實作簡單且易於追蹤
  - Docker 環境隔離，開發與生產環境一致

- **缺點**：
  - 需要新建 7 張表，Migration 工作量較大
  - JWT 需要妥善管理 Secret Key 與 Token 過期時間
  - 舊表（profiles, skills, projects）需要手動清理或備份

- **為何選擇**：
  - 需求明確要求三角色系統，必須重新設計使用者架構
  - JWT 是業界標準，適合 API 專案
  - 現有表結構部分可重用，避免全部重寫

### 技術架構

```
[前端 React]
      ↓ HTTPS + JWT Token
[API Gateway - Routes.php]
      ↓
[AuthFilter (JWT 驗證)] → [RoleFilter (權限檢查)]
      ↓
[API Controllers]
  ├─ AuthController (登入/註冊)
  ├─ SalespersonController (業務員資料)
  ├─ SearchController (公開搜尋)
  └─ AdminController (管理功能)
      ↓
[Models 層]
  ├─ UserModel (使用者帳號)
  ├─ SalespersonProfileModel (業務員資料)
  ├─ CompanyModel (公司資訊)
  ├─ CertificationModel (證照)
  └─ ApprovalLogModel (審核記錄)
      ↓
[MySQL 資料庫]
```

### 關鍵技術點

1. **JWT 認證機制**
   - 套件：`firebase/php-jwt`
   - Access Token 有效期：1 小時
   - Refresh Token 有效期：7 天
   - Token 儲存：前端 localStorage（Access）+ httpOnly Cookie（Refresh，可選）

2. **審核狀態機**
   ```
   pending (待審核) → approved (通過)
                    → rejected (拒絕)

   狀態轉換規則：
   - 業務員註冊：pending → Admin 審核 → approved/rejected
   - 機敏資料修改：auto → pending → Admin 審核 → approved/rejected
   - 一般資料修改：auto → approved（無需審核）
   ```

3. **權限控制（RBAC）**
   - roles 欄位：'salesperson', 'user', 'admin'
   - AuthFilter：驗證 JWT Token 有效性
   - RoleFilter：驗證使用者角色權限
   - 端點保護：
     - `/api/auth/*`：公開
     - `/api/search/*`：公開
     - `/api/salesperson/*`：需要 salesperson 角色
     - `/api/admin/*`：需要 admin 角色

4. **搜尋機制**
   - 全文搜尋：使用 MySQL `LIKE '%keyword%'` 或 `FULLTEXT INDEX`
   - 多條件查詢：WHERE + JOIN + AND/OR
   - 分頁：使用 CI4 的 `paginate()` 方法
   - 索引優化：在 company_name, industry_id, region_id 建立索引

5. **檔案儲存**
   - 方式：MEDIUMBLOB（最大 16MB）
   - 欄位：avatar_data (BLOB), avatar_mime (VARCHAR), avatar_size (INT)
   - 上傳限制：5MB, 格式限制 JPG/PNG/PDF
   - 回傳方式：Base64 編碼（API 回應）

---

## 實作計畫

### 檔案修改清單

| 檔案路徑 | 動作 | 說明 | 優先級 |
|---------|------|------|--------|
| **composer.json** | 修改 | 新增 firebase/php-jwt 依賴 | P0 |
| **app/Database/Migrations/2026-01-07-000001_CreateUsersTable.php** | 新增 | 建立使用者表（三角色） | P0 |
| **app/Database/Migrations/2026-01-07-000002_CreateSalespersonProfilesTable.php** | 新增 | 建立業務員資料表 | P0 |
| **app/Database/Migrations/2026-01-07-000003_CreateCompaniesTable.php** | 新增 | 建立公司資訊表 | P0 |
| **app/Database/Migrations/2026-01-07-000004_ModifyExperiencesTable.php** | 新增 | 修改工作經歷表（加 user_id, approval_status） | P0 |
| **app/Database/Migrations/2026-01-07-000005_CreateCertificationsTable.php** | 新增 | 建立證照表（改造自 education） | P0 |
| **app/Database/Migrations/2026-01-07-000006_CreateIndustriesTable.php** | 新增 | 建立產業類別表 | P1 |
| **app/Database/Migrations/2026-01-07-000007_CreateRegionsTable.php** | 新增 | 建立地區表 | P1 |
| **app/Database/Migrations/2026-01-07-000008_CreateApprovalLogsTable.php** | 新增 | 建立審核記錄表 | P1 |
| **app/Models/UserModel.php** | 新增 | 使用者模型（含密碼雜湊、角色驗證） | P0 |
| **app/Models/SalespersonProfileModel.php** | 新增 | 業務員資料模型 | P0 |
| **app/Models/CompanyModel.php** | 新增 | 公司資訊模型 | P0 |
| **app/Models/CertificationModel.php** | 新增 | 證照模型 | P0 |
| **app/Models/ApprovalLogModel.php** | 新增 | 審核記錄模型 | P1 |
| **app/Models/IndustryModel.php** | 新增 | 產業類別模型 | P1 |
| **app/Models/RegionModel.php** | 新增 | 地區模型 | P1 |
| **app/Libraries/JWTLib.php** | 新增 | JWT 工具類別（生成、驗證、刷新 Token） | P0 |
| **app/Filters/AuthFilter.php** | 新增 | JWT 認證過濾器 | P0 |
| **app/Filters/RoleFilter.php** | 新增 | 角色權限過濾器 | P0 |
| **app/Config/Filters.php** | 修改 | 註冊自訂 Filters + 啟用 CORS | P0 |
| **app/Config/Routes.php** | 修改 | 新增 API 路由群組（/api/*） | P0 |
| **app/Config/Cors.php** | 修改 | 設定 CORS 允許來源 | P1 |
| **app/Controllers/BaseController.php** | 修改 | 加入 ResponseTrait 與共用方法 | P0 |
| **app/Controllers/Api/AuthController.php** | 新增 | 認證控制器（註冊、登入、登出、刷新） | P0 |
| **app/Controllers/Api/SalespersonController.php** | 新增 | 業務員資料管理 | P0 |
| **app/Controllers/Api/SearchController.php** | 新增 | 公開搜尋功能 | P0 |
| **app/Controllers/Api/AdminController.php** | 新增 | 管理員功能（審核、使用者管理、系統設定、統計） | P1 |
| **app/Database/Seeds/SystemDataSeeder.php** | 新增 | 系統基礎資料（產業類別、地區、測試 Admin 帳號） | P1 |
| **app/Database/Seeds/TestSalespersonSeeder.php** | 新增 | 測試用業務員資料 | P2 |
| **.env** | 修改 | 新增 JWT_SECRET_KEY, JWT_ACCESS_EXPIRY, JWT_REFRESH_EXPIRY | P0 |

**優先級說明：**
- **P0（最高）**：核心功能，必須優先完成，阻塞後續開發
- **P1（中等）**：重要功能，影響完整性但不阻塞核心開發
- **P2（低）**：輔助功能，可最後完成

---

### 執行步驟

#### **階段 1：環境準備與依賴安裝** (預估: 15 分鐘)

**任務：**
1. 安裝 JWT 套件：`composer require firebase/php-jwt`
2. 備份現有資料庫（mysqldump）
3. 修改 .env 檔案，新增 JWT 配置：
   ```
   JWT_SECRET_KEY=your-256-bit-secret-key-here-change-in-production
   JWT_ACCESS_EXPIRY=3600          # 1 小時
   JWT_REFRESH_EXPIRY=604800       # 7 天
   ```
4. 確認 Docker 容器運行正常

**驗證點：**
- ✓ composer.json 包含 firebase/php-jwt
- ✓ .env 包含 JWT 配置
- ✓ 執行 `docker-compose ps` 顯示所有服務運行中
- ✓ 資料庫備份檔案存在（my_profile_backup_YYYYMMDD.sql）

**相依關係：** 無（起始任務）

---

#### **階段 2：資料庫架構改造** (預估: 90 分鐘)

**任務：**

2.1 **建立核心 Migrations（P0）**
   - `2026-01-07-000001_CreateUsersTable.php`
     - 欄位：id, username, email, password_hash, role (ENUM), status (ENUM), email_verified_at, created_at, updated_at, deleted_at
     - 索引：UNIQUE(email), UNIQUE(username), INDEX(role)

   - `2026-01-07-000002_CreateSalespersonProfilesTable.php`
     - 欄位：id, user_id (FK), company_id (FK nullable), full_name, phone, bio, specialties (TEXT), service_regions (JSON), avatar_data (MEDIUMBLOB), avatar_mime, avatar_size, approval_status (ENUM), approved_by (FK nullable), approved_at, created_at, updated_at
     - 索引：FK(user_id), FK(company_id), INDEX(approval_status)

   - `2026-01-07-000003_CreateCompaniesTable.php`
     - 欄位：id, name, tax_id, industry_id (FK), address, phone, approval_status (ENUM), created_by (FK), approved_by (FK nullable), approved_at, created_at, updated_at
     - 索引：UNIQUE(tax_id), INDEX(industry_id), INDEX(approval_status)

   - `2026-01-07-000004_ModifyExperiencesTable.php`
     - 新增欄位：user_id (FK), approval_status (ENUM: pending, approved), approved_by (FK nullable), approved_at
     - 修改欄位：start_date (DATE), end_date (DATE nullable)
     - 新增索引：FK(user_id), INDEX(approval_status)

   - `2026-01-07-000005_CreateCertificationsTable.php`
     - 欄位：id, user_id (FK), name, issuer, issue_date (DATE), expiry_date (DATE nullable), file_data (MEDIUMBLOB), file_mime, file_size, approval_status (ENUM), approved_by (FK nullable), approved_at, created_at, updated_at
     - 索引：FK(user_id), INDEX(approval_status)

2.2 **建立輔助 Migrations（P1）**
   - `2026-01-07-000006_CreateIndustriesTable.php`
     - 欄位：id, name, slug, description, created_at, updated_at

   - `2026-01-07-000007_CreateRegionsTable.php`
     - 欄位：id, name, slug, parent_id (FK nullable), created_at, updated_at

   - `2026-01-07-000008_CreateApprovalLogsTable.php`
     - 欄位：id, approvable_type, approvable_id, action (approved/rejected), admin_id (FK), reason (TEXT nullable), created_at

2.3 **執行 Migrations**
   ```bash
   docker-compose exec app php spark migrate
   ```

2.4 **建立 Seeder**
   - `SystemDataSeeder.php`：產業類別（科技、金融、製造等）、地區（北中南東）、測試 Admin 帳號
   - 執行：`docker-compose exec app php spark db:seed SystemDataSeeder`

**驗證點：**
- ✓ 執行 `php spark migrate:status` 顯示所有 Migrations 已執行
- ✓ 執行 `SHOW TABLES` 確認 8 張新表已建立
- ✓ 執行 `SELECT * FROM industries` 有基礎資料
- ✓ 執行 `SELECT * FROM users WHERE role='admin'` 存在測試 Admin 帳號

**相依關係：** 階段 1 完成

---

#### **階段 3：認證系統建置** (預估: 120 分鐘)

**任務：**

3.1 **建立 JWT Library**
   - 檔案：`app/Libraries/JWTLib.php`
   - 方法：
     - `generateAccessToken($userId, $email, $role)`：生成 Access Token
     - `generateRefreshToken($userId)`：生成 Refresh Token
     - `verifyToken($token)`：驗證 Token 並回傳 Payload
     - `isTokenExpired($token)`：檢查 Token 是否過期

3.2 **建立 UserModel**
   - 檔案：`app/Models/UserModel.php`
   - 方法：
     - `beforeInsert()`：密碼雜湊（使用 password_hash）
     - `beforeUpdate()`：密碼雜湊
     - `verifyPassword($inputPassword, $hashedPassword)`：驗證密碼
     - `findByEmail($email)`：依 Email 查詢使用者
   - 驗證規則：
     - email: required|valid_email|is_unique
     - username: required|min_length[3]|is_unique
     - password: required|min_length[8]

3.3 **建立 AuthFilter**
   - 檔案：`app/Filters/AuthFilter.php`
   - 功能：
     - 檢查 Authorization Header 是否存在
     - 提取 Bearer Token
     - 使用 JWTLib 驗證 Token
     - 將使用者資訊注入 Request（$request->user）
     - Token 無效或過期回傳 401 Unauthorized

3.4 **建立 RoleFilter**
   - 檔案：`app/Filters/RoleFilter.php`
   - 功能：
     - 從 Request 取得使用者資訊
     - 檢查使用者角色是否符合路由要求
     - 權限不足回傳 403 Forbidden

3.5 **註冊 Filters**
   - 修改：`app/Config/Filters.php`
   - 新增 aliases：
     ```php
     'auth' => \App\Filters\AuthFilter::class,
     'role' => \App\Filters\RoleFilter::class,
     ```
   - 設定全域 CORS（開發環境）：
     ```php
     'before' => ['cors'],
     ```

3.6 **建立 AuthController**
   - 檔案：`app/Controllers/Api/AuthController.php`
   - 端點：
     - `POST /api/auth/register`：業務員註冊（建立 user + salesperson_profile，狀態 pending）
     - `POST /api/auth/login`：登入（驗證帳密，回傳 JWT Token）
     - `POST /api/auth/refresh`：刷新 Access Token
     - `POST /api/auth/logout`：登出（前端清除 Token）
     - `GET /api/auth/me`：取得當前使用者資訊（需 auth Filter）

3.7 **修改 BaseController**
   - 檔案：`app/Controllers/BaseController.php`
   - 繼承：`CodeIgniter\RESTful\ResourceController`
   - 新增共用方法：
     - `respondSuccess($data, $message)`：統一成功回應格式
     - `respondError($message, $statusCode, $errors)`：統一錯誤回應格式
     - `respondUnauthorized($message)`：401 回應
     - `respondForbidden($message)`：403 回應

3.8 **設定 API 路由**
   - 修改：`app/Config/Routes.php`
   - 新增路由群組：
     ```php
     $routes->group('api', function($routes) {
         // 公開路由
         $routes->group('auth', function($routes) {
             $routes->post('register', 'Api\AuthController::register');
             $routes->post('login', 'Api\AuthController::login');
             $routes->post('refresh', 'Api\AuthController::refresh');
             $routes->post('logout', 'Api\AuthController::logout');
         });

         // 需認證路由
         $routes->group('auth', ['filter' => 'auth'], function($routes) {
             $routes->get('me', 'Api\AuthController::me');
         });
     });
     ```

**驗證點：**
- ✓ 使用 Postman 測試 `POST /api/auth/register`，成功建立業務員帳號，狀態為 pending
- ✓ 使用 Postman 測試 `POST /api/auth/login`，成功回傳 JWT Token
- ✓ 使用 Postman 測試 `GET /api/auth/me`（帶 Token），成功取得使用者資訊
- ✓ 使用 Postman 測試 `GET /api/auth/me`（不帶 Token），回傳 401
- ✓ 使用 Postman 測試 `POST /api/auth/refresh`，成功刷新 Token
- ✓ 檢查資料庫 users 表，密碼已雜湊儲存（非明文）

**相依關係：** 階段 2 完成

---

#### **階段 4：業務員功能開發** (預估: 150 分鐘)

**任務：**

4.1 **建立 Models（P0）**
   - `app/Models/SalespersonProfileModel.php`
     - 方法：`getApprovedProfiles()`, `getPendingProfiles()`, `updateApprovalStatus($id, $status, $adminId)`

   - `app/Models/CompanyModel.php`
     - 方法：`getApprovedCompanies()`, `getPendingCompanies()`

   - `app/Models/CertificationModel.php`
     - 方法：`getByUserId($userId)`, `getPendingCertifications()`

   - `app/Models/ExperienceModel.php`（修改現有）
     - 新增方法：`getByUserId($userId)`, `getPendingExperiences()`

4.2 **建立 SalespersonController**
   - 檔案：`app/Controllers/Api/SalespersonController.php`
   - Filter：所有端點需 'auth' + 'role:salesperson'
   - 端點：
     - `GET /api/salesperson/profile`：取得個人資料
     - `PUT /api/salesperson/profile`：更新個人資料（一般欄位即時生效，檔案上傳需審核）
     - `POST /api/salesperson/company`：新增/更新公司資訊（需審核）
     - `GET /api/salesperson/experiences`：取得工作經歷列表
     - `POST /api/salesperson/experiences`：新增工作經歷
     - `PUT /api/salesperson/experiences/:id`：更新工作經歷
     - `DELETE /api/salesperson/experiences/:id`：刪除工作經歷
     - `GET /api/salesperson/certifications`：取得證照列表
     - `POST /api/salesperson/certifications`：上傳證照（需審核）
     - `DELETE /api/salesperson/certifications/:id`：刪除證照
     - `GET /api/salesperson/approval-status`：查看所有待審核項目

4.3 **實作審核狀態邏輯**
   - 規則：
     - 首次建立：`approval_status = 'pending'`
     - 一般欄位更新（bio, phone）：保持原狀態或直接 'approved'
     - 機敏欄位更新（company_id, 證照檔案）：改為 'pending'
   - 在 Model 的 `beforeUpdate()` 中實作自動狀態轉換

4.4 **實作檔案處理**
   - 大頭貼上傳：
     - 驗證：檔案大小 < 5MB, MIME 類型 image/jpeg|png
     - 轉換：讀取檔案內容，儲存為 BLOB
     - 儲存：`avatar_data`, `avatar_mime`, `avatar_size`
   - 證照上傳：同大頭貼邏輯

4.5 **設定路由**
   - 修改：`app/Config/Routes.php`
   - 新增：
     ```php
     $routes->group('api', function($routes) {
         $routes->group('salesperson', ['filter' => 'auth|role:salesperson'], function($routes) {
             $routes->get('profile', 'Api\SalespersonController::getProfile');
             $routes->put('profile', 'Api\SalespersonController::updateProfile');
             $routes->post('company', 'Api\SalespersonController::saveCompany');
             $routes->resource('experiences', ['controller' => 'Api\SalespersonController']);
             $routes->resource('certifications', ['controller' => 'Api\SalespersonController']);
             $routes->get('approval-status', 'Api\SalespersonController::getApprovalStatus');
         });
     });
     ```

**驗證點：**
- ✓ 業務員登入後，可成功取得個人資料
- ✓ 更新一般資料（bio），無需審核直接生效
- ✓ 新增公司資訊，狀態變為 pending
- ✓ 上傳大頭貼（< 5MB JPG），成功儲存於資料庫
- ✓ 上傳證照，狀態為 pending
- ✓ 查看審核狀態，正確列出所有待審核項目
- ✓ 非業務員角色（如 admin）無法存取業務員端點（403）

**相依關係：** 階段 3 完成

---

#### **階段 5：搜尋功能開發** (預估: 90 分鐘)

**任務：**

5.1 **建立 SearchController**
   - 檔案：`app/Controllers/Api/SearchController.php`
   - Filter：公開路由（無需認證）
   - 端點：
     - `GET /api/search/salespersons`：搜尋業務員
       - Query 參數：
         - `keyword`：關鍵字（搜尋姓名、bio、公司名稱）
         - `company`：公司名稱（精確或模糊）
         - `industry_id`：產業類別 ID
         - `region_id`：地區 ID
         - `page`：頁碼（預設 1）
         - `per_page`：每頁筆數（預設 20）
         - `sort`：排序（latest, relevant）
       - 回傳：分頁列表（僅 approved 狀態）

     - `GET /api/search/salespersons/:id`：查看業務員詳細資料
       - 回傳：完整資料（不含機敏資訊，如密碼、審核紀錄）

5.2 **實作搜尋邏輯**
   - 基礎查詢：
     ```php
     $builder = $this->salespersonProfileModel
         ->select('salesperson_profiles.*, companies.name as company_name, industries.name as industry_name')
         ->join('companies', 'companies.id = salesperson_profiles.company_id', 'left')
         ->join('industries', 'industries.id = companies.industry_id', 'left')
         ->where('salesperson_profiles.approval_status', 'approved')
         ->where('companies.approval_status', 'approved'); // 公司也需已審核
     ```

   - 條件過濾：
     - keyword：`LIKE %keyword%` 於 full_name, bio, companies.name
     - company：`companies.name LIKE %company%`
     - industry_id：`companies.industry_id = ?`
     - region_id：`JSON_CONTAINS(service_regions, ?)`（需 MySQL 5.7+）

   - 排序：
     - latest：`ORDER BY created_at DESC`
     - relevant：依 keyword 匹配度（可簡化為 created_at DESC）

5.3 **優化查詢效能**
   - 新增索引：
     - `CREATE INDEX idx_approval_status ON salesperson_profiles(approval_status);`
     - `CREATE INDEX idx_company_name ON companies(name);`
     - `CREATE INDEX idx_industry_id ON companies(industry_id);`
   - 使用 CI4 Query Builder 的 `paginate()` 方法

5.4 **設定路由**
   - 修改：`app/Config/Routes.php`
   - 新增：
     ```php
     $routes->group('api', function($routes) {
         $routes->group('search', function($routes) {
             $routes->get('salespersons', 'Api\SearchController::search');
             $routes->get('salespersons/(:num)', 'Api\SearchController::show/$1');
         });
     });
     ```

**驗證點：**
- ✓ 不帶任何參數，回傳所有已審核業務員（分頁）
- ✓ 搜尋 keyword="工程師"，正確篩選出相關業務員
- ✓ 搜尋 company="台積電"，正確篩選出該公司業務員
- ✓ 搜尋 industry_id=1（科技業），正確篩選
- ✓ 多條件組合搜尋（keyword + industry + region），正確篩選
- ✓ 查看業務員詳細資料（/api/search/salespersons/1），正確回傳
- ✓ 未審核的業務員不會出現在搜尋結果中
- ✓ 無需登入即可存取搜尋 API（公開）

**相依關係：** 階段 4 完成

---

#### **階段 6：管理員功能開發** (預估: 120 分鐘)

**任務：**

6.1 **建立 ApprovalLogModel**
   - 檔案：`app/Models/ApprovalLogModel.php`
   - 方法：`logApproval($type, $id, $action, $adminId, $reason)`

6.2 **建立 AdminController**
   - 檔案：`app/Controllers/Api/AdminController.php`
   - Filter：所有端點需 'auth' + 'role:admin'
   - 端點：

     **審核管理**：
     - `GET /api/admin/pending-approvals`：取得所有待審核項目（業務員註冊、公司、證照）
     - `POST /api/admin/approve-user/:id`：審核通過業務員註冊
     - `POST /api/admin/reject-user/:id`：拒絕業務員註冊
     - `POST /api/admin/approve-company/:id`：審核通過公司資訊
     - `POST /api/admin/reject-company/:id`：拒絕公司資訊
     - `POST /api/admin/approve-certification/:id`：審核通過證照
     - `POST /api/admin/reject-certification/:id`：拒絕證照

     **使用者管理**：
     - `GET /api/admin/users`：取得使用者列表（分頁、篩選）
     - `PUT /api/admin/users/:id/status`：停用/啟用帳號
     - `DELETE /api/admin/users/:id`：刪除帳號（軟刪除）

     **系統設定**：
     - `GET /api/admin/settings/industries`：取得產業類別列表
     - `POST /api/admin/settings/industries`：新增產業類別
     - `PUT /api/admin/settings/industries/:id`：更新產業類別
     - `DELETE /api/admin/settings/industries/:id`：刪除產業類別
     - `GET /api/admin/settings/regions`：取得地區列表
     - `POST /api/admin/settings/regions`：新增地區

     **平台統計**：
     - `GET /api/admin/statistics`：取得平台統計資料
       - 業務員總數（已審核/待審核）
       - 公司總數
       - 證照總數
       - 近 30 天註冊趨勢
       - （可選）搜尋熱門關鍵字

6.3 **實作審核邏輯**
   - 審核通過：
     1. 更新 `approval_status = 'approved'`
     2. 記錄 `approved_by` 和 `approved_at`
     3. 寫入 ApprovalLog
   - 審核拒絕：
     1. 更新 `approval_status = 'rejected'`
     2. 記錄拒絕原因（reason）
     3. 寫入 ApprovalLog
     4. （可選）發送通知給業務員

6.4 **建立輔助 Models**
   - `app/Models/IndustryModel.php`：產業類別 CRUD
   - `app/Models/RegionModel.php`：地區 CRUD

6.5 **設定路由**
   - 修改：`app/Config/Routes.php`
   - 新增：
     ```php
     $routes->group('api', function($routes) {
         $routes->group('admin', ['filter' => 'auth|role:admin'], function($routes) {
             // 審核管理
             $routes->get('pending-approvals', 'Api\AdminController::getPendingApprovals');
             $routes->post('approve-user/(:num)', 'Api\AdminController::approveUser/$1');
             $routes->post('reject-user/(:num)', 'Api\AdminController::rejectUser/$1');
             $routes->post('approve-company/(:num)', 'Api\AdminController::approveCompany/$1');
             $routes->post('reject-company/(:num)', 'Api\AdminController::rejectCompany/$1');
             $routes->post('approve-certification/(:num)', 'Api\AdminController::approveCertification/$1');
             $routes->post('reject-certification/(:num)', 'Api\AdminController::rejectCertification/$1');

             // 使用者管理
             $routes->get('users', 'Api\AdminController::getUsers');
             $routes->put('users/(:num)/status', 'Api\AdminController::updateUserStatus/$1');
             $routes->delete('users/(:num)', 'Api\AdminController::deleteUser/$1');

             // 系統設定
             $routes->resource('settings/industries', ['controller' => 'Api\AdminController']);
             $routes->resource('settings/regions', ['controller' => 'Api\AdminController']);

             // 統計
             $routes->get('statistics', 'Api\AdminController::getStatistics');
         });
     });
     ```

**驗證點：**
- ✓ Admin 登入後，可取得所有待審核項目列表
- ✓ Admin 審核通過業務員註冊，業務員狀態變為 approved，可正常登入
- ✓ Admin 拒絕證照，證照狀態變為 rejected
- ✓ Admin 可停用業務員帳號，該業務員無法登入
- ✓ Admin 可新增產業類別，新類別出現在選項中
- ✓ Admin 可查看平台統計資料
- ✓ 所有審核操作都記錄在 approval_logs 表中
- ✓ 非 admin 角色無法存取管理員端點（403）

**相依關係：** 階段 4, 5 完成

---

#### **階段 7：CORS 與最終整合** (預估: 30 分鐘)

**任務：**

7.1 **配置 CORS**
   - 修改：`app/Config/Cors.php`
   - 設定：
     ```php
     public array $default = [
         'allowedOrigins' => ['http://localhost:3000', 'http://localhost:5173'], // React/Vite 開發伺服器
         'allowedOriginsPatterns' => [],
         'allowedHeaders' => ['Content-Type', 'Authorization', 'X-Requested-With'],
         'allowedMethods' => ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH'],
         'exposedHeaders' => [],
         'maxAge' => 7200,
         'supportsCredentials' => false,
     ];
     ```

7.2 **啟用全域 CORS Filter**
   - 修改：`app/Config/Filters.php`
   - 設定：
     ```php
     public array $globals = [
         'before' => [
             'cors',
         ],
         'after' => [],
     ];
     ```

7.3 **統一錯誤處理**
   - 修改：`app/Config/Routes.php`
   - 新增 404 處理：
     ```php
     $routes->set404Override(function() {
         return service('response')->setJSON([
             'status' => 'error',
             'message' => 'API endpoint not found'
         ])->setStatusCode(404);
     });
     ```

7.4 **API 文件準備**
   - 建立：`/Users/kai/KAA/my_profile/API文件.md`
   - 內容：所有 API 端點、請求範例、回應範例、錯誤碼說明

7.5 **整合測試**
   - 測試完整流程：
     1. 業務員註冊 → 待審核
     2. Admin 審核通過 → 業務員可登入
     3. 業務員上傳資料 → 機敏資料待審核
     4. Admin 審核公司/證照 → 通過
     5. 一般使用者搜尋 → 可找到該業務員
     6. 業務員修改一般資料 → 即時生效
     7. 業務員修改公司資訊 → 再次待審核

**驗證點：**
- ✓ 從 React 前端（localhost:3000）發送 API 請求，無 CORS 錯誤
- ✓ OPTIONS 預檢請求正確回應 200
- ✓ 存取不存在的端點，回傳統一的 404 JSON 錯誤
- ✓ 完整流程測試通過（註冊→審核→上傳→搜尋）
- ✓ API 文件完整，包含所有端點說明

**相依關係：** 階段 3-6 完成

---

### 相依關係圖

```
階段 1 (環境準備)
    ↓
階段 2 (資料庫改造)
    ↓
階段 3 (認證系統)
    ↓
階段 4 (業務員功能) ←→ 階段 5 (搜尋功能)
    ↓                      ↓
    └──────→ 階段 6 (管理員功能)
                    ↓
            階段 7 (CORS與整合)
```

**關鍵路徑**：階段 1 → 2 → 3 → 4 → 6 → 7
**並行開發**：階段 4 與階段 5 可同時進行（不同開發者）

---

## 風險評估

| 風險項目 | 影響程度 | 發生機率 | 緩解措施 |
|---------|---------|---------|---------|
| **JWT Secret 洩漏** | 高 | 低 | 1. 使用強隨機字串（256-bit）<br>2. .env 加入 .gitignore<br>3. 生產環境使用環境變數<br>4. 定期輪換 Secret Key |
| **資料庫 Migration 失敗** | 中 | 低 | 1. 執行前備份資料庫<br>2. 先在測試環境驗證<br>3. 撰寫 Migration 的 down() 方法以支援 rollback |
| **CORS 配置錯誤導致前端無法存取** | 中 | 中 | 1. 開發階段使用寬鬆設定（localhost:*）<br>2. 使用 Postman 先測試 API<br>3. 檢查瀏覽器 Console 的 CORS 錯誤訊息 |
| **檔案上傳過大導致記憶體不足** | 中 | 中 | 1. 限制檔案大小 5MB<br>2. 設定 PHP memory_limit（256MB）<br>3. 設定 upload_max_filesize, post_max_size（10MB）<br>4. 未來考慮改用雲端儲存（S3） |
| **SQL Injection 漏洞** | 高 | 低 | 1. 使用 CI4 Query Builder（自動參數化查詢）<br>2. 避免使用 raw SQL<br>3. 啟用 prepared statements<br>4. 執行安全測試工具掃描 |
| **審核機制邏輯錯誤** | 中 | 中 | 1. 撰寫單元測試覆蓋所有狀態轉換<br>2. 在 Model 層集中管理狀態邏輯<br>3. 使用狀態機模式確保轉換正確<br>4. 手動測試所有審核流程 |
| **Token 過期時間設定不當** | 低 | 中 | 1. Access Token 設定較短（1小時）<br>2. Refresh Token 設定較長（7天）<br>3. 前端實作自動刷新機制<br>4. 提供「記住我」選項 |
| **搜尋效能瓶頸（大量資料）** | 中 | 中 | 1. 在關鍵欄位建立索引<br>2. 限制每頁筆數（最多 50）<br>3. 使用 MySQL EXPLAIN 分析查詢<br>4. 未來考慮引入 Elasticsearch |
| **並發審核衝突** | 低 | 低 | 1. 在審核時檢查當前狀態<br>2. 使用資料庫交易（Transaction）<br>3. 樂觀鎖機制（version 欄位）|
| **舊資料表（profiles, skills, projects）誤用** | 低 | 中 | 1. 執行 Migration 後立即清空或重新命名舊表<br>2. 在程式碼中明確註解哪些表已廢棄<br>3. 文件中說明新舊表對應關係 |

**最高風險**：JWT Secret 洩漏、SQL Injection
**建議優先處理**：在階段 1 確保 .env 不被提交至 Git，階段 3 嚴格使用 Query Builder

---

## 測試策略

### 單元測試（PHPUnit）
**範圍：**
- JWTLib：Token 生成、驗證、過期檢查
- UserModel：密碼雜湊、驗證、Email 查詢
- SalespersonProfileModel：審核狀態轉換邏輯
- CompanyModel：審核狀態轉換
- ApprovalLogModel：記錄建立

**目標：**
- 測試覆蓋率 > 60%
- 關鍵邏輯測試覆蓋率 > 90%

**執行方式：**
```bash
docker-compose exec app vendor/bin/phpunit --filter JWTLib
docker-compose exec app vendor/bin/phpunit --filter UserModel
```

### 整合測試（PHPUnit + Database）
**範圍：**
- AuthController：註冊、登入、Token 刷新完整流程
- SalespersonController：CRUD 操作與審核狀態變化
- SearchController：多條件搜尋結果正確性
- AdminController：審核操作與使用者管理

**執行方式：**
```bash
docker-compose exec app vendor/bin/phpunit --testsuite Integration
```

### API 測試（Postman / Newman）
**範圍：**
- 建立 Postman Collection 包含所有 API 端點
- 測試項目：
  - 正常流程（Happy Path）
  - 邊界條件（空值、過長輸入）
  - 錯誤處理（無效 Token、權限不足）
  - 並發請求（同時審核）

**Postman Collection 包含：**
- Environment 變數：baseURL, adminToken, salespersonToken
- Pre-request Scripts：自動取得 Token
- Tests：自動驗證回應狀態碼與資料格式

**執行方式：**
```bash
newman run API測試.postman_collection.json -e 開發環境.postman_environment.json
```

### 安全測試
**工具：**
- OWASP ZAP：自動化漏洞掃描
- Burp Suite：手動滲透測試

**檢查項目：**
- [ ] SQL Injection（在所有查詢參數）
- [ ] XSS（在所有輸出欄位）
- [ ] CSRF（雖然 API 使用 JWT，但仍需檢查）
- [ ] 未授權存取（測試無 Token 存取受保護端點）
- [ ] 權限提升（業務員嘗試存取 Admin 端點）
- [ ] Token 重放攻擊（使用過期 Token）

### 手動測試清單
**完整流程測試：**
1. [ ] 業務員註冊 → 狀態為 pending，無法登入
2. [ ] Admin 登入 → 審核業務員 → 審核通過
3. [ ] 業務員登入 → 取得 JWT Token
4. [ ] 業務員建立個人資料 → 成功建立
5. [ ] 業務員上傳大頭貼（< 5MB）→ 成功儲存，可在 API 回應中看到 Base64 編碼
6. [ ] 業務員新增公司資訊 → 狀態為 pending
7. [ ] Admin 審核公司 → 審核通過
8. [ ] 業務員新增工作經歷 → 成功建立
9. [ ] 業務員上傳證照 → 狀態為 pending
10. [ ] Admin 審核證照 → 審核通過
11. [ ] 一般使用者（不登入）搜尋業務員 → 可找到該業務員
12. [ ] 搜尋條件：關鍵字「工程師」→ 正確篩選
13. [ ] 搜尋條件：公司名稱 → 正確篩選
14. [ ] 搜尋條件：產業類別 + 地區 → 正確篩選
15. [ ] 查看業務員詳細資料 → 回傳完整資料（不含密碼）
16. [ ] 業務員修改 bio（一般資料）→ 立即生效，無需審核
17. [ ] 業務員修改公司資訊 → 狀態變為 pending
18. [ ] Admin 停用業務員帳號 → 該業務員無法登入
19. [ ] Admin 查看統計資料 → 正確顯示業務員數量、待審核數量
20. [ ] Token 過期後，使用 Refresh Token → 成功取得新 Access Token

---

## 部署計畫

### 開發環境部署（Docker）
**步驟：**
1. 確保 Docker Desktop 運行中
2. 執行：
   ```bash
   cd /Users/kai/KAA/my_profile/my_profile_ci4
   docker-compose up -d --build
   ```
3. 執行 Migrations：
   ```bash
   docker-compose exec app php spark migrate
   ```
4. 執行 Seeder：
   ```bash
   docker-compose exec app php spark db:seed SystemDataSeeder
   ```
5. 驗證：訪問 http://localhost:8080/api/auth/login

### 生產環境部署考量（未來）
**建議架構：**
- Web 伺服器：Nginx + PHP-FPM（取代 Apache）
- 資料庫：MySQL 8.0（獨立伺服器或 RDS）
- SSL 憑證：Let's Encrypt（HTTPS）
- 反向代理：Nginx 處理 CORS、Rate Limiting
- 容器編排：Kubernetes 或 Docker Swarm

**環境變數：**
- `CI_ENVIRONMENT=production`
- `JWT_SECRET_KEY`：使用強隨機字串（512-bit）
- `database.default.*`：生產資料庫連線資訊
- `app.baseURL`：正式域名

**安全加固：**
1. 關閉 Debug Toolbar
2. 啟用 HTTPS Only（ForceHTTPS Filter）
3. 設定 Rate Limiting（防止 API 濫用）
4. 設定 CSP Headers
5. 啟用 SQL 查詢日誌監控
6. 定期備份資料庫

### 回滾方案
**資料庫回滾：**
```bash
# 回滾最後一批 Migrations
docker-compose exec app php spark migrate:rollback

# 回滾至特定版本
docker-compose exec app php spark migrate:version 2026-01-07-000003

# 恢復備份
docker-compose exec db mysql -u root -p my_profile < backup_YYYYMMDD.sql
```

**程式碼回滾：**
```bash
# 使用 Git 回滾
git log --oneline
git revert <commit-hash>

# 或直接 reset（危險，僅限開發環境）
git reset --hard <commit-hash>
```

---

## 驗收標準檢查表

### 功能驗收
- [ ] **F1**：業務員可成功註冊，初始狀態為「待審核」，資料正確寫入 users 與 salesperson_profiles 表
- [ ] **F2**：業務員註冊後無法登入，審核通過後可正常登入並取得 JWT Token
- [ ] **F3**：JWT Token 包含 user_id、email、role，且可正確驗證
- [ ] **F4**：Access Token 過期後，可使用 Refresh Token 刷新取得新 Token
- [ ] **F5**：業務員可建立/編輯個人資料（姓名、電話、bio、專業領域、服務地區）
- [ ] **F6**：業務員可上傳大頭貼（< 5MB, JPG/PNG），檔案儲存於資料庫 BLOB
- [ ] **F7**：業務員可新增/編輯工作經歷，資料正確寫入 experiences 表
- [ ] **F8**：業務員可新增/編輯公司資訊（公司名稱、統編、產業類別），首次建立狀態為 pending
- [ ] **F9**：業務員可上傳證照（< 5MB, JPG/PNG/PDF），狀態為 pending
- [ ] **F10**：業務員可查看所有待審核項目的狀態（公司、證照、經歷）
- [ ] **F11**：一般資料修改（bio, phone）即時生效，無需審核
- [ ] **F12**：機敏資料修改（公司名稱、統編、證照）狀態變為 pending，需重新審核
- [ ] **F13**：一般使用者可透過多條件搜尋業務員（關鍵字、公司、產業、地區）
- [ ] **F14**：搜尋結果僅顯示 approval_status = 'approved' 的業務員
- [ ] **F15**：搜尋結果分頁正確，預設每頁 20 筆
- [ ] **F16**：一般使用者可查看業務員詳細資料，不含機敏資訊（密碼、審核紀錄）
- [ ] **F17**：Admin 可取得所有待審核項目列表（業務員註冊、公司、證照）
- [ ] **F18**：Admin 可審核通過業務員註冊，狀態變為 approved，記錄審核者與時間
- [ ] **F19**：Admin 可拒絕業務員註冊，狀態變為 rejected，可填寫拒絕原因
- [ ] **F20**：Admin 可審核公司資訊、證照，審核操作記錄於 approval_logs
- [ ] **F21**：Admin 可停用/啟用業務員帳號，停用後該業務員無法登入
- [ ] **F22**：Admin 可刪除使用者（軟刪除），deleted_at 欄位記錄刪除時間
- [ ] **F23**：Admin 可管理系統設定（新增/編輯產業類別、地區選項）
- [ ] **F24**：Admin 可查看平台統計（業務員總數、待審核數、近期註冊趨勢）

### 安全驗收
- [ ] **S1**：所有密碼使用 bcrypt 雜湊儲存，資料庫無明文密碼
- [ ] **S2**：JWT Secret Key 儲存於 .env，不提交至 Git
- [ ] **S3**：所有 API 端點使用參數化查詢，無 SQL Injection 漏洞（使用 OWASP ZAP 掃描）
- [ ] **S4**：所有輸出使用 `esc()` 函數，無 XSS 漏洞
- [ ] **S5**：受保護的 API 端點（/api/salesperson/*, /api/admin/*）需有效 JWT Token
- [ ] **S6**：業務員無法存取 Admin 端點，回傳 403 Forbidden
- [ ] **S7**：Admin 無法存取其他業務員的私人資料（除非透過審核功能）
- [ ] **S8**：過期或無效的 JWT Token 無法通過驗證，回傳 401 Unauthorized
- [ ] **S9**：CORS 設定正確，僅允許指定來源（localhost:3000, localhost:5173）
- [ ] **S10**：檔案上傳限制生效（大小 5MB、格式 JPG/PNG/PDF），超出限制回傳 400 錯誤

### 資料驗收
- [ ] **D1**：執行 `php spark migrate:status`，所有 8 個新 Migrations 狀態為 Ran
- [ ] **D2**：users 表包含必要欄位且資料類型正確（role 為 ENUM）
- [ ] **D3**：salesperson_profiles 表包含 approval_status 欄位（ENUM: pending, approved, rejected）
- [ ] **D4**：companies 表包含 tax_id（統編）欄位，且有 UNIQUE 約束
- [ ] **D5**：certifications 表可儲存檔案（BLOB 欄位不為空）
- [ ] **D6**：experiences 表包含 user_id 外鍵，關聯至 users 表
- [ ] **D7**：approval_logs 表記錄所有審核操作，包含 admin_id 與 action
- [ ] **D8**：industries 與 regions 表包含系統基礎資料（至少 5 筆產業、4 個地區）
- [ ] **D9**：測試 Admin 帳號存在（role = 'admin'），可正常登入
- [ ] **D10**：外鍵約束正確設定（ON DELETE CASCADE 或 RESTRICT）

### API 規範驗收
- [ ] **A1**：所有 API 端點遵循 RESTful 設計（使用正確的 HTTP Method）
- [ ] **A2**：成功回應統一格式：`{ status: 'success', message: '...', data: {...} }`
- [ ] **A3**：錯誤回應統一格式：`{ status: 'error', message: '...', errors: {...} }`
- [ ] **A4**：HTTP 狀態碼正確使用（200 成功、201 建立、400 驗證錯誤、401 未授權、403 禁止、404 未找到、500 伺服器錯誤）
- [ ] **A5**：分頁回應包含 meta 資訊（total, per_page, current_page, last_page）
- [ ] **A6**：所有日期時間使用 ISO 8601 格式（YYYY-MM-DD HH:MM:SS）
- [ ] **A7**：檔案上傳回應包含檔案資訊（mime, size, base64）
- [ ] **A8**：API 文件完整，包含所有端點、請求範例、回應範例、錯誤碼說明

### 效能驗收
- [ ] **P1**：搜尋 API（/api/search/salespersons）回應時間 < 500ms（100 筆資料）
- [ ] **P2**：登入 API（/api/auth/login）回應時間 < 300ms
- [ ] **P3**：資料庫查詢使用索引（使用 EXPLAIN 檢查）
- [ ] **P4**：上傳 5MB 檔案成功且無記憶體溢出錯誤

---

## 開發規範

### 程式碼標準
1. **命名規範**：
   - 類別：PascalCase（UserModel, AuthController）
   - 方法：camelCase（getUserById, verifyToken）
   - 變數：camelCase（$userId, $accessToken）
   - 常數：UPPER_SNAKE_CASE（JWT_SECRET_KEY）

2. **註解規範**：
   - 所有 public 方法需要 PHPDoc 註解
   - 複雜邏輯需要行內註解說明
   - API 端點需要註解說明用途、參數、回應格式

3. **錯誤處理**：
   - 使用 try-catch 包裝可能失敗的操作
   - 所有錯誤回傳統一格式 JSON
   - 記錄錯誤到 log 檔案（使用 log_message()）

4. **安全原則**：
   - 永遠使用 Query Builder 或 ORM，不使用 raw SQL
   - 所有使用者輸入必須驗證
   - 所有輸出必須使用 esc() 函數
   - 密碼必須雜湊後儲存

### Git 工作流程
1. **分支策略**：
   - `main`：穩定版本
   - `develop`：開發版本
   - `feature/*`：功能分支（feature/auth-system, feature/search-api）
   - `hotfix/*`：緊急修復

2. **Commit 訊息格式**：
   ```
   [類型] 簡短描述（50字內）

   詳細說明（選填）

   類型：feat（新功能）、fix（修復）、refactor（重構）、docs（文件）、test（測試）
   ```
   範例：
   ```
   [feat] 實作 JWT 認證系統

   - 新增 JWTLib 類別
   - 建立 AuthFilter 驗證 Token
   - 實作 Token 刷新機制
   ```

3. **Code Review**：
   - 所有程式碼需經過 Review 才能合併至 develop
   - Review 檢查項目：功能正確性、安全性、效能、程式碼品質

---

## 附錄

### 資料表關聯圖（ER Diagram）

```
users (使用者表)
  ├─ id (PK)
  ├─ username
  ├─ email
  ├─ password_hash
  ├─ role (ENUM: salesperson, user, admin)
  ├─ status (ENUM: pending, active, inactive)
  └─ ...

salesperson_profiles (業務員資料表)
  ├─ id (PK)
  ├─ user_id (FK → users.id)
  ├─ company_id (FK → companies.id, nullable)
  ├─ full_name
  ├─ phone
  ├─ bio
  ├─ specialties (TEXT)
  ├─ service_regions (JSON)
  ├─ avatar_data (BLOB)
  ├─ approval_status (ENUM: pending, approved, rejected)
  └─ ...

companies (公司表)
  ├─ id (PK)
  ├─ name
  ├─ tax_id (UNIQUE)
  ├─ industry_id (FK → industries.id)
  ├─ approval_status (ENUM: pending, approved, rejected)
  └─ ...

experiences (工作經歷表)
  ├─ id (PK)
  ├─ user_id (FK → users.id)  [新增]
  ├─ company
  ├─ position
  ├─ start_date (DATE)  [修改]
  ├─ end_date (DATE, nullable)  [修改]
  ├─ approval_status (ENUM)  [新增]
  └─ ...

certifications (證照表)
  ├─ id (PK)
  ├─ user_id (FK → users.id)
  ├─ name
  ├─ issuer
  ├─ file_data (BLOB)
  ├─ approval_status (ENUM: pending, approved, rejected)
  └─ ...

industries (產業類別表)
  ├─ id (PK)
  ├─ name
  ├─ slug
  └─ ...

regions (地區表)
  ├─ id (PK)
  ├─ name
  ├─ slug
  └─ ...

approval_logs (審核記錄表)
  ├─ id (PK)
  ├─ approvable_type (VARCHAR: 'user', 'company', 'certification')
  ├─ approvable_id (INT)
  ├─ action (ENUM: approved, rejected)
  ├─ admin_id (FK → users.id)
  ├─ reason (TEXT, nullable)
  └─ created_at
```

### API 端點總覽

**認證模組（公開）**
```
POST   /api/auth/register     - 業務員註冊
POST   /api/auth/login        - 登入
POST   /api/auth/refresh      - 刷新 Token
POST   /api/auth/logout       - 登出
GET    /api/auth/me           - 取得當前使用者資訊 [需認證]
```

**業務員模組（需認證：salesperson）**
```
GET    /api/salesperson/profile               - 取得個人資料
PUT    /api/salesperson/profile               - 更新個人資料
POST   /api/salesperson/company               - 新增/更新公司資訊
GET    /api/salesperson/experiences           - 取得工作經歷列表
POST   /api/salesperson/experiences           - 新增工作經歷
PUT    /api/salesperson/experiences/:id       - 更新工作經歷
DELETE /api/salesperson/experiences/:id       - 刪除工作經歷
GET    /api/salesperson/certifications        - 取得證照列表
POST   /api/salesperson/certifications        - 上傳證照
DELETE /api/salesperson/certifications/:id    - 刪除證照
GET    /api/salesperson/approval-status       - 查看審核狀態
```

**搜尋模組（公開）**
```
GET    /api/search/salespersons       - 搜尋業務員
GET    /api/search/salespersons/:id   - 查看業務員詳細資料
```

**管理員模組（需認證：admin）**
```
# 審核管理
GET    /api/admin/pending-approvals              - 取得待審核列表
POST   /api/admin/approve-user/:id               - 審核通過業務員註冊
POST   /api/admin/reject-user/:id                - 拒絕業務員註冊
POST   /api/admin/approve-company/:id            - 審核通過公司資訊
POST   /api/admin/reject-company/:id             - 拒絕公司資訊
POST   /api/admin/approve-certification/:id      - 審核通過證照
POST   /api/admin/reject-certification/:id       - 拒絕證照

# 使用者管理
GET    /api/admin/users                  - 取得使用者列表
PUT    /api/admin/users/:id/status       - 停用/啟用帳號
DELETE /api/admin/users/:id              - 刪除帳號

# 系統設定
GET    /api/admin/settings/industries          - 取得產業類別列表
POST   /api/admin/settings/industries          - 新增產業類別
PUT    /api/admin/settings/industries/:id      - 更新產業類別
DELETE /api/admin/settings/industries/:id      - 刪除產業類別
GET    /api/admin/settings/regions             - 取得地區列表
POST   /api/admin/settings/regions             - 新增地區

# 統計
GET    /api/admin/statistics                    - 取得平台統計資料
```

**總計：35 個 API 端點**

---

## 結語

本實作計畫提供了完整的技術方案與執行步驟，將現有的個人作品集系統改造為功能完整的業務推廣平台後端 API。計畫涵蓋了資料庫設計、認證系統、業務邏輯、搜尋功能、管理功能等所有核心需求，並制定了詳細的驗收標準與測試策略。

**關鍵成功因素：**
1. 嚴格遵循執行步驟的順序（相依關係）
2. 每個階段完成後進行驗證，確保無誤才進入下一階段
3. 優先處理高風險項目（JWT Secret 管理、SQL Injection 防護）
4. 使用 Git 版本控制，每個功能完成後提交
5. 完整的測試覆蓋（單元測試 + 整合測試 + API 測試）

**預估總工時：8-10 個工作天**
- 資深開發者（單人）：8 天
- 中階開發者（單人）：10-12 天
- 團隊協作（2 人）：5-6 天（階段 4 與 5 並行）

**下一步：等待用戶確認計畫，確認後交付給 Developer 執行。**

---

**計畫制定者**：Tech Lead
**計畫版本**：v1.0
**最後更新**：2026-01-07
